<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç½ç¦æ‡‰è®Šå¿—å·¥åª’åˆç³»çµ±</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    /************************************************************
     * 1. æ¨¡æ“¬ä½¿ç”¨è€… & SPA ç‹€æ…‹
     ************************************************************/

    const USERS = {
      publisher: {
        id: "publisher_001",
        name: localStorage.getItem('publisherName') || "ä»»å‹™ç™¼å¸ƒè€… Demo",
        role: "publisher"
      },
      volunteer: { id: "volunteer_001", name: "å¿—å·¥ Demo", role: "volunteer" }
    };

    let currentUser = USERS.publisher;

    let currentPage = "roleSelect"; // roleSelect | publisherDashboard | publisherMissionDetail | editMissionForm | volunteerProfileForm | volunteerMissionList
    let currentMission = null;

    const $ = (id) => document.getElementById(id);

    function navigateTo(page, params = {}) {
      console.log(`Navigating to page: ${page}`, params); // é™¤éŒ¯ï¼šè¨˜éŒ„å°èˆª
      currentPage = page;
      if (page === "roleSelect") renderRoleSelect();
      else if (page === "publisherDashboard") renderPublisherDashboard();
      else if (page === "publisherMissionDetail") {
        currentMission = params.mission;
        renderPublisherMissionDetail(currentMission);
      } else if (page === "editMissionForm") {
        currentMission = params.mission;
        renderEditMissionForm(currentMission);
      } else if (page === "createMissionForm") renderCreateMissionForm();
      else if (page === "volunteerProfileForm") renderVolunteerProfileForm();
      else if (page === "volunteerMissionList") renderVolunteerMissionList();
      else if (page === "missionChat") {
        currentMission = params.mission;
        renderMissionChat(currentMission);
      }
      else {
        renderRoleSelect();
      }
    }

    /************************************************************
     * 2. LocalStorage "è³‡æ–™åº«" æ“ä½œ
     ************************************************************/

    const STORAGE_KEY = "volunteerApp";

    function loadDB() {
      const raw = localStorage.getItem(STORAGE_KEY);
      let db;
      if (!raw) {
        db = {
          missions: [],
          accepts: [],
          notifications: [],
          profiles: [],
          chatMessages: [],
          seq: 1
        };
      } else {
        db = JSON.parse(raw);
        if (!db.profiles) db.profiles = [];
        if (!db.chatMessages) db.chatMessages = [];
      }
      localStorage.setItem(STORAGE_KEY, JSON.stringify(db));
      return db;
    }

    function saveDB(db) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(db));
    }

    function genId(prefix) {
      const db = loadDB();
      const id = `${prefix}_${db.seq}`;
      db.seq += 1;
      saveDB(db);
      return id;
    }

    // ---- Missions CRUD ----
    function getMissions() {
      return loadDB().missions;
    }

    function getMissionById(id) {
      return getMissions().find((m) => m.id === id) || null;
    }

    function updateMission(id, updates) {
      const db = loadDB();
      const missionIndex = db.missions.findIndex((m) => m.id === id);
      if (missionIndex >= 0) {
        db.missions[missionIndex] = { ...db.missions[missionIndex], ...updates };
        saveDB(db);
        return true;
      }
      return false;
    }

    function addMission(mission) {
      const db = loadDB();
      db.missions.push(mission);
      saveDB(db);
    }

    // ---- Accepts ----
    function getAcceptsByMission(missionId) {
      return loadDB().accepts.filter((a) => a.missionId === missionId);
    }

    function addAccept(record) {
      const db = loadDB();
      db.accepts.push(record);
      saveDB(db);
    }

    // ---- Notifications ----
    function getNotificationsByPublisher(publisherId) {
      return loadDB().notifications
        .filter((n) => n.publisherId === publisherId)
        .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
    }

    function addNotification(noti) {
      const db = loadDB();
      db.notifications.push(noti);
      saveDB(db);
    }

    function markAllNotificationsRead(publisherId) {
      const db = loadDB();
      db.notifications = db.notifications.map((n) =>
        n.publisherId === publisherId ? { ...n, read: true } : n
      );
      saveDB(db);
    }

    // ---- User Utilities ----
    function getUserNameById(userId) {
      if (userId === USERS.publisher.id) {
        return USERS.publisher.name;
      } else if (userId === USERS.volunteer.id) {
        return USERS.volunteer.name;
      }
      return "æœªçŸ¥ç”¨æˆ¶";
    }

    // ---- Chat Messages ----
    function getChatMessagesByMission(missionId) {
      return loadDB().chatMessages
        .filter((msg) => msg.missionId === missionId)
        .sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
    }

    function addChatMessage(message) {
      const db = loadDB();
      db.chatMessages.push(message);
      saveDB(db);
    }

    // ---- Map Utilities ----
    function generateMapHtml(location, height = "300") {
      const encodedLocation = encodeURIComponent(location);
      const mapId = 'map-' + Math.random().toString(36).substr(2, 9);
      return `
        <div class="map-container">
          <div class="relative">
            <iframe
              src="https://maps.google.com/maps?q=${encodedLocation}&output=embed&z=15&t=m&hl=zh-TW"
              width="100%"
              height="${height}"
              frameborder="0"
              style="border:0; border-radius:0.375rem;"
              allowfullscreen
              loading="lazy"
              referrerpolicy="no-referrer-when-downgrade">
            </iframe>
            <div class="absolute top-2 right-2">
              <button
                onclick="showMapFallback(this, '${encodedLocation}')"
                class="bg-white bg-opacity-90 hover:bg-opacity-100 text-gray-600 hover:text-gray-800 px-2 py-1 rounded text-xs shadow-sm border transition-colors"
                title="å¦‚æœåœ°åœ–è¼‰å…¥å¤±æ•—ï¼Œé»æ“Šé€™è£¡æŸ¥çœ‹æ›¿ä»£æ–¹æ¡ˆ"
              >
                ğŸ”„
              </button>
            </div>
          </div>
        </div>
      `;
    }

    function toggleMissionDetail(detailId) {
      const detailElement = document.getElementById(detailId);
      if (detailElement) {
        detailElement.style.display = detailElement.style.display === 'none' ? 'block' : 'none';
      }
    }

    function showMapFallback(button, encodedLocation) {
      const container = button.closest('.map-container');
      const mapDiv = button.closest('.relative');

      // éš±è—åœ°åœ–å€åŸŸ
      mapDiv.style.display = 'none';

      // å‰µå»ºå‚™ç”¨åœ°åœ–
      const fallback = document.createElement('div');
      fallback.style.cssText = `width:100%; height:${mapDiv.offsetHeight}px; background:#f3f4f6; border:1px solid #d1d5db; border-radius:0.375rem; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center; padding:1rem;`;
      fallback.innerHTML = `
        <div class="text-gray-600 mb-2">
          <svg class="w-8 h-8 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
          </svg>
          <p class="text-sm font-medium">åˆ‡æ›åˆ°å‚™ç”¨åœ°åœ–</p>
        </div>
        <a
          href="https://www.google.com/maps/search/?api=1&query=${encodedLocation}"
          target="_blank"
          class="inline-flex items-center px-3 py-2 text-sm font-medium text-blue-600 bg-blue-50 rounded-lg hover:bg-blue-100 transition-colors"
        >
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
          </svg>
          åœ¨Google Mapsä¸­æŸ¥çœ‹
        </a>
      `;

      container.appendChild(fallback);
    }

    // ---- Profiles ----
    function getProfileById(id) {
      return loadDB().profiles.find((p) => p.id === id) || null;
    }

    function saveProfile(profile) {
      const db = loadDB();
      const existingIndex = db.profiles.findIndex((p) => p.id === profile.id);
      if (existingIndex >= 0) {
        db.profiles[existingIndex] = profile;
      } else {
        db.profiles.push(profile);
      }
      saveDB(db);
    }

    /************************************************************
     * æ–°å¢ï¼šä»»å‹™è‡ªå‹•åŒ¹é…ç³»çµ±
     ************************************************************/

    // è¨ˆç®—ä»»å‹™èˆ‡å¿—å·¥çš„åŒ¹é…åˆ†æ•¸ï¼ˆåŸºæ–¼æŠ€èƒ½é—œéµå­—é‡ç–Šï¼‰
    function calculateMatchScore(mission, volunteerProfile) {
      if (!volunteerProfile) {
        return 0;
      }

      // å¦‚æœä»»å‹™é¸æ“‡"æœ‰æ„é¡˜çš†å¯"ï¼Œå‰‡æ‰€æœ‰å¿—å·¥éƒ½åŒ¹é…
      if (mission.skills && mission.skills.includes("æœ‰æ„é¡˜çš†å¯")) {
        return 10; // çµ¦äºˆé«˜åˆ†ï¼Œè®“é€™äº›ä»»å‹™å„ªå…ˆé¡¯ç¤º
      }

      if (!volunteerProfile.skills || !mission.skills) {
        return 0;
      }

      const volunteerSkills = volunteerProfile.skills.toLowerCase().split(/[,ï¼Œ\s]+/).filter(s => s.trim());
      const missionSkills = mission.skills.toLowerCase().split(/[,ï¼Œ\s]+/).filter(s => s.trim());
      let score = 0;
      volunteerSkills.forEach(vSkill => {
        if (missionSkills.some(mSkill => mSkill.includes(vSkill) || vSkill.includes(mSkill))) {
          score += 1; // ç°¡å–®é‡ç–Šè¨ˆåˆ†ï¼Œå¯æ“´å±•ç‚ºæ¬Šé‡
        }
      });
      console.log(`Match score for mission ${mission.id}: ${score}`); // é™¤éŒ¯
      return score;
    }

    // ç²å–æ¨è–¦ä»»å‹™ï¼ˆåŸºæ–¼åŒ¹é…åˆ†æ•¸æ’åºï¼‰
    function getRecommendedMissions(volunteerProfile, missions) {
      return missions
        .map(m => ({ mission: m, score: calculateMatchScore(m, volunteerProfile) }))
        .filter(item => item.score > 0)
        .sort((a, b) => b.score - a.score)
        .slice(0, 3); // å‰3å€‹æ¨è–¦
    }

    /************************************************************
     * 3. æ¬Šé™ & ç‹€æ…‹åˆ¤æ–·
     ************************************************************/

    function canEditMission(mission, userId) {
      return (
        mission.postedBy === userId &&
        mission.status === "open" &&
        (mission.acceptedCount || 0) < (mission.requiredVolunteers || 0)
      );
    }

    function canCloseMission(mission, userId) {
      return mission.postedBy === userId && mission.status === "open";
    }

    function canOpenMission(mission, userId) {
      return mission.postedBy === userId && mission.status === "closed";
    }

    function canCompleteMission(mission, userId) {
      // åªæœ‰ç™¼ä½ˆè€…ä¸”ç‹€æ…‹ç‚º open æˆ– closed æ‰èƒ½å®Œæˆ
      return mission.postedBy === userId && (mission.status === "open" || mission.status === "closed");
    }

    /************************************************************
     * 4. é€šçŸ¥ badge
     ************************************************************/

    function renderNotificationBadge() {
      const badge = $("notification-badge");
      if (!badge) return;
      const notifications = getNotificationsByPublisher(currentUser.id);
      const unreadCount = notifications.filter((n) => !n.read).length;
      if (unreadCount > 0) {
        badge.textContent = unreadCount;
        badge.className =
          "ml-2 inline-flex items-center justify-center px-2 py-0.5 text-xs font-semibold rounded-full bg-red-500 text-white";
      } else {
        badge.textContent = "";
        badge.className = "";
      }
    }

    /************************************************************
     * 5. è§’è‰²é¸æ“‡é 
     ************************************************************/

    function renderRoleSelect() {
      console.log("Rendering role select page"); // é™¤éŒ¯ï¼šè¨˜éŒ„æ¸²æŸ“
      const app = $("app");
      app.innerHTML = `
        <div class="min-h-screen bg-slate-100 flex items-center justify-center">
          <div class="w-[390px] bg-white rounded-xl shadow-lg p-8 space-y-6">
            <h1 class="text-2xl font-bold text-center">ç½ç¦æ‡‰è®Šå¿—å·¥åª’åˆ</h1>
            <p class="text-sm text-gray-600 text-center">
              é¸æ“‡ä¸€å€‹è§’è‰²ä¾†é«”é©—ï¼š
            </p>

            <div class="space-y-3">
              <button
                id="btn-as-publisher"
                class="w-full px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700"
              >
                æˆ‘è¦ç™¼å¸ƒä»»å‹™
              </button>

              <button
                id="btn-as-volunteer"
                class="w-full px-4 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700"
              >
                æˆ‘è¦ç•¶å¿—å·¥
              </button>
            </div>

            <div class="border-t pt-4 text-xs text-gray-500 space-y-1">
              <p>ç›®å‰è§’è‰²ï¼š<span class="font-medium">${currentUser.name}ï¼ˆ${currentUser.role}ï¼‰</span></p>
              <p>æ‰€æœ‰è³‡æ–™çš†å„²å­˜åœ¨ç€è¦½å™¨ LocalStorage ä¸­ï¼ˆ${STORAGE_KEY}ï¼‰ã€‚</p>
            </div>
          </div>
        </div>
      `;

      // ç¢ºä¿æŒ‰éˆ•å­˜åœ¨å¾Œç¶å®šäº‹ä»¶
      const btnPublisher = $("btn-as-publisher");
      const btnVolunteer = $("btn-as-volunteer");
      console.log("Buttons found:", btnPublisher, btnVolunteer); // é™¤éŒ¯ï¼šæª¢æŸ¥æŒ‰éˆ•å…ƒç´ 

      if (btnPublisher) {
        btnPublisher.addEventListener("click", () => {
          console.log("Publisher button clicked"); // é™¤éŒ¯ï¼šè¨˜éŒ„é»æ“Š
          renderPublisherNameInput();
        });
      }

      if (btnVolunteer) {
        btnVolunteer.addEventListener("click", () => {
          console.log("Volunteer button clicked"); // é™¤éŒ¯ï¼šè¨˜éŒ„é»æ“Š
          currentUser = USERS.volunteer;
          navigateTo("volunteerProfileForm");
        });
      }
    }

    function renderPublisherNameInput() {
      // å¦‚æœå·²ç¶“æœ‰ä¿å­˜çš„åå­—ï¼Œç›´æ¥é€²å…¥å„€è¡¨æ¿
      const savedName = localStorage.getItem('publisherName');
      if (savedName) {
        USERS.publisher.name = savedName;
        currentUser = USERS.publisher;
        navigateTo("publisherDashboard");
        return;
      }

      console.log("Rendering publisher name input"); // é™¤éŒ¯
      const app = $("app");
      app.innerHTML = `
        <div class="min-h-screen bg-slate-100 flex items-center justify-center">
          <div class="w-[390px] bg-white rounded-xl shadow-lg p-8 space-y-6">
            <div class="text-center">
              <h1 class="text-2xl font-bold">è¨­å®šæ‚¨çš„åç¨±</h1>
              <p class="text-sm text-gray-600 mt-2">
                è«‹è¼¸å…¥æ‚¨ä½œç‚ºä»»å‹™ç™¼å¸ƒè€…çš„åç¨±
              </p>
            </div>

            <form id="publisher-name-form" class="space-y-4">
              <div>
                <label for="publisher-name" class="block text-sm font-medium text-gray-700 mb-1">
                  æ‚¨çš„åç¨±
                </label>
                <input
                  id="publisher-name"
                  type="text"
                  placeholder="ä¾‹å¦‚ï¼šç‹å°æ˜"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                  maxlength="20"
                  required
                >
              </div>

              <div class="flex gap-3">
                <button
                  type="button"
                  id="btn-back-role"
                  class="flex-1 px-4 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300"
                >
                  è¿”å›
                </button>
                <button
                  type="submit"
                  class="flex-1 px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700"
                >
                  ç¢ºèªé€²å…¥
                </button>
              </div>
            </form>
          </div>
        </div>
      `;

      // ç¶å®šäº‹ä»¶
      const form = $("publisher-name-form");
      const input = $("publisher-name");
      const btnBack = $("btn-back-role");

      if (btnBack) {
        btnBack.onclick = () => navigateTo("roleSelect");
      }

      if (form && input) {
        form.onsubmit = (e) => {
          e.preventDefault();
          const name = input.value.trim();
          if (!name) {
            alert("è«‹è¼¸å…¥æ‚¨çš„åç¨±");
            return;
          }

          // æ›´æ–°ç™¼å¸ƒè€…åå­—ä¸¦ä¿å­˜åˆ° localStorage
          USERS.publisher.name = name;
          localStorage.setItem('publisherName', name);

          // è¨­ç½®ç•¶å‰ç”¨æˆ¶ä¸¦é€²å…¥å„€è¡¨æ¿
          currentUser = USERS.publisher;
          navigateTo("publisherDashboard");
        };
      }
    }

    /************************************************************
     * 6. å¿—å·¥å±¥æ­·å¡«å¯«é 
     ************************************************************/

    function renderVolunteerProfileForm() {
      console.log("Rendering volunteer profile form"); // é™¤éŒ¯ï¼šè¨˜éŒ„æ¸²æŸ“
      const app = $("app");
      const existingProfile = getProfileById(currentUser.id) || {};

      app.innerHTML = `
        <div class="min-h-screen bg-slate-100 flex items-center justify-center">
          <div class="w-[390px] bg-white rounded-xl shadow-lg p-8 space-y-6">
            <div class="flex items-center justify-between mb-4">
              <h1 class="text-xl font-bold">å¿—å·¥å±¥æ­·å¡«å¯«</h1>
              <button
                id="btn-back-role"
                class="px-3 py-1 text-sm rounded bg-gray-200 hover:bg-gray-300"
              >
                â† å›åˆ°è§’è‰²é¸æ“‡
              </button>
            </div>

            <form id="volunteer-profile-form" class="space-y-4">
              <div>
                <label class="block text-sm font-medium mb-1">å§“å</label>
                <input
                  type="text"
                  name="name"
                  class="w-full border rounded px-3 py-2 text-sm"
                  value="${existingProfile.name || ""}"
                  required
                />
              </div>

              <div>
                <label class="block text-sm font-medium mb-1">è¯çµ¡æ–¹å¼</label>
                <input
                  type="tel"
                  name="phone"
                  class="w-full border rounded px-3 py-2 text-sm"
                  value="${existingProfile.phone || ""}"
                  required
                />
              </div>

              <div>
                <label class="block text-sm font-medium mb-1">ç¾åœ¨ä½ç½®</label>
                <input
                  type="text"
                  name="location"
                  class="w-full border rounded px-3 py-2 text-sm"
                  value="${existingProfile.location || ""}"
                  placeholder="ä¾‹å¦‚ï¼šå°åŒ—å¸‚å¤§å®‰å€"
                />
              </div>

              <div>
                <label class="block text-sm font-medium mb-1">æ€§åˆ¥</label>
                <select name="gender" class="w-full border rounded px-3 py-2 text-sm">
                  <option value="unspecified" ${!existingProfile.gender || existingProfile.gender === 'unspecified' ? 'selected' : ''}>æœªæŒ‡å®š</option>
                  <option value="male" ${existingProfile.gender === 'male' ? 'selected' : ''}>ç”·æ€§</option>
                  <option value="female" ${existingProfile.gender === 'female' ? 'selected' : ''}>å¥³æ€§</option>
                  <option value="other" ${existingProfile.gender === 'other' ? 'selected' : ''}>å…¶ä»–ï¼ä¸é€éœ²</option>
                </select>
              </div>

              <div>
                <label class="block text-sm font-medium mb-1">æŠ€èƒ½ / å°ˆé•·ï¼ˆå‹¾é¸é©ç”¨é …ç›®ï¼‰</label>
                <div class="grid grid-cols-2 gap-2">
                  ${["æ¬é‹", "æ°´é›»", "çƒ¹é£ª", "é§•é§›", "é†«ç™‚", "ç…§è­·", "å‹˜æŸ¥", "æ–‡æ›¸"].map(skill => {
                    const currentSkills = (existingProfile.skills || "").split(/[ã€,\s]+/).filter(s => s.trim());
                    const isChecked = currentSkills.includes(skill);
                    return `
                      <label class="flex items-center">
                        <input
                          type="checkbox"
                          name="skills"
                          value="${skill}"
                          class="mr-2"
                          ${isChecked ? 'checked' : ''}
                        />
                        ${skill}
                      </label>
                    `;
                  }).join('')}
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium mb-1">å¯ç”¨å·¥å…·ï¼ˆå‹¾é¸é©ç”¨é …ç›®ï¼‰</label>
                <div class="grid grid-cols-2 gap-2">
                  ${["éŸå­", "æ‰‹æ¨è»Š", "æ©Ÿè»Š", "è²¨è»Š", "å…¶ä»–", "ç„¡ç‰¹æ®Šå·¥å…·"].map(tool => {
                    const currentTools = (existingProfile.tools || "").split(/[ã€,\s]+/).filter(s => s.trim());
                    const isChecked = currentTools.includes(tool);
                    return `
                      <label class="flex items-center">
                        <input
                          type="checkbox"
                          name="tools"
                          value="${tool}"
                          class="mr-2"
                          ${isChecked ? 'checked' : ''}
                        />
                        ${tool}
                      </label>
                    `;
                  }).join('')}
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium mb-1">è‡ªæˆ‘ä»‹ç´¹</label>
                <textarea
                  name="bio"
                  rows="4"
                  class="w-full border rounded px-3 py-2 text-sm"
                  placeholder="ç°¡çŸ­ä»‹ç´¹è‡ªå·±"
                >${existingProfile.bio || ""}</textarea>
              </div>

              <div class="flex gap-3 pt-2">
                <button
                  type="submit"
                  class="px-4 py-2 text-sm rounded bg-emerald-600 text-white hover:bg-emerald-700"
                >
                  å„²å­˜ä¸¦é€²å…¥ä»»å‹™åˆ—è¡¨
                </button>
                <button
                  type="button"
                  id="btn-cancel-profile"
                  class="px-4 py-2 text-sm rounded bg-gray-200 hover:bg-gray-300"
                >
                  å–æ¶ˆ
                </button>
              </div>
            </form>
          </div>
        </div>
      `;

      const btnBack = $("btn-back-role");
      const btnCancel = $("btn-cancel-profile");
      const form = $("volunteer-profile-form");

      if (btnBack) {
        btnBack.onclick = () => {
          console.log("Back button clicked"); // é™¤éŒ¯
          navigateTo("roleSelect");
        };
      }

      if (btnCancel) {
        btnCancel.onclick = () => {
          console.log("Cancel button clicked"); // é™¤éŒ¯
          navigateTo("roleSelect");
        };
      }

      if (form) {
        form.onsubmit = (e) => {
          console.log("Form submitted"); // é™¤éŒ¯
          handleVolunteerProfileSubmit(e);
        };
      }
    }

    function handleVolunteerProfileSubmit(event) {
      event.preventDefault();

      const form = event.target;

      // è™•ç†å‹¾é¸æ¡†çš„æŠ€èƒ½èˆ‡å·¥å…·ï¼Œä¸¦æ”¶é›†ä½ç½®èˆ‡æ€§åˆ¥
      const selectedSkills = Array.from(form.skills || [])
        .filter(checkbox => checkbox.checked)
        .map(checkbox => checkbox.value);
      const selectedTools = Array.from(form.tools || [])
        .filter(checkbox => checkbox.checked)
        .map(checkbox => checkbox.value);

      const profile = {
        id: currentUser.id,
        name: form.name.value.trim(),
        phone: form.phone.value.trim(),
        location: form.location.value.trim(),
        gender: form.gender.value || 'unspecified',
        skills: selectedSkills.join('ã€'), // å°‡å‹¾é¸çš„æŠ€èƒ½ç”¨é “è™Ÿé€£æ¥
        tools: selectedTools.join('ã€'), // å°‡å‹¾é¸çš„å·¥å…·ç”¨é “è™Ÿé€£æ¥
        bio: form.bio.value.trim(),
        updatedAt: new Date().toISOString()
      };

      saveProfile(profile);

      // æ›´æ–° currentUser ç‚º profile
      currentUser = { ...currentUser, ...profile };

      alert("å±¥æ­·å„²å­˜æˆåŠŸï¼");
      navigateTo("volunteerMissionList");
    }

    /************************************************************
     * 7. ç™¼å¸ƒè€… Dashboardï¼ˆä»»å‹™åˆ—è¡¨ + çµ±è¨ˆ + é€šçŸ¥ï¼‰
     ************************************************************/

    function calculateStatsForPublisher(missions) {
      const mine = missions.filter((m) => m.postedBy === currentUser.id);
      const totalMissions = mine.length;
      const completedMissions = mine.filter((m) => m.status === "completed").length;
      const completionRate =
        totalMissions === 0
          ? 0
          : Math.round((completedMissions / totalMissions) * 100);
      const totalVolunteerParticipations = mine.reduce(
        (sum, m) => sum + (m.acceptedCount || 0),
        0
      );

      return { totalMissions, completedMissions, completionRate, totalVolunteerParticipations };
    }

    function renderPublisherDashboard() {
      console.log("Rendering publisher dashboard"); // é™¤éŒ¯
      const app = $("app");
      const allMissions = getMissions();
      const myMissions = allMissions.filter((m) => m.postedBy === currentUser.id);
      const stats = calculateStatsForPublisher(allMissions);
      const notifications = getNotificationsByPublisher(currentUser.id);
      const latestNotis = notifications.slice(0, 3);

      app.innerHTML = `
        <div class="min-h-screen bg-slate-100 flex items-center justify-center">
          <div class="w-[390px] bg-white rounded-xl shadow-lg p-8 space-y-6">
            <header class="bg-white shadow-sm">
              <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
                <div class="flex items-center gap-2">
                  <h1 class="text-xl font-bold">ä»»å‹™ç™¼å¸ƒè€…å¾Œå°</h1>
                  <span class="text-xs text-gray-500">
                    ä½¿ç”¨è€…ï¼š${currentUser.name}ï¼ˆ${currentUser.id}ï¼‰</span>
                </div>
                <div class="flex items-center gap-4 text-sm">
                  <button id="btn-notifications" class="relative text-gray-700 hover:text-gray-900">
                    é€šçŸ¥
                    <span id="notification-badge"></span>
                  </button>
                  <button id="btn-go-volunteer" class="text-gray-600 hover:text-gray-900">
                    åˆ‡æ›ç‚ºå¿—å·¥
                  </button>
                  <button id="btn-back-role" class="text-gray-600 hover:text-gray-900">
                    è§’è‰²é¸æ“‡
                  </button>
                </div>
              </div>
            </header>

            <main class="max-w-6xl mx-auto px-4 py-4 space-y-4">
              <!-- çµ±è¨ˆ -->
              <section class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                <div class="bg-white border rounded-lg p-3">
                  <div class="text-xs text-gray-500 mb-1">æ­·ä¾†ä»»å‹™æ•¸</div>
                  <div class="text-2xl font-semibold">${stats.totalMissions}</div>
                </div>
                <div class="bg-white border rounded-lg p-3">
                  <div class="text-xs text-gray-500 mb-1">å®Œæˆä»»å‹™æ•¸ / å®Œæˆç‡</div>
                  <div class="text-lg font-semibold">
                    ${stats.completedMissions}ï¼ˆ${stats.completionRate}%ï¼‰
                  </div>
                </div>
                <div class="bg-white border rounded-lg p-3">
                  <div class="text-xs text-gray-500 mb-1">å¿—å·¥äººæ¬¡ï¼ˆacceptedCount åŠ ç¸½ï¼‰</div>
                  <div class="text-2xl font-semibold">${stats.totalVolunteerParticipations}</div>
                </div>
              </section>

              <!-- æœ€æ–°é€šçŸ¥ -->
              <section class="bg-white border rounded-lg p-3">
                <div class="flex items-center justify-between mb-2">
                  <h2 class="text-sm font-semibold">æœ€æ–°é€šçŸ¥</h2>
                  <span class="text-xs text-gray-500">
                    å…± ${notifications.length} å‰‡ï¼ˆæœªè®€ ${notifications.filter((n) => !n.read).length}ï¼‰
                  </span>
                </div>
                ${
                  latestNotis.length === 0
                    ? `<p class="text-xs text-gray-500">ç›®å‰å°šç„¡é€šçŸ¥ã€‚</p>`
                    : `
                  <ul class="space-y-1 text-sm">
                    ${latestNotis
                      .map((n) => {
                        const readClass = n.read ? "text-gray-500" : "text-gray-900 font-medium";
                        return `
                          <li class="${readClass}">
                            [å¿—å·¥æ¥å—ä»»å‹™] æœ‰æ–°å¿—å·¥æ¥æ”¶äº†æ‚¨çš„ä»»å‹™
                            <span class="text-xs text-gray-400 ml-1">
                              ${n.createdAt ? new Date(n.createdAt).toLocaleString() : ""}
                            </span>
                          </li>
                        `;
                      })
                      .join("")}
                  </ul>
                `
                }
              </section>

              <!-- ä»»å‹™åˆ—è¡¨ -->
              <section class="bg-white border rounded-lg p-3">
                <div class="flex items-center justify-between mb-2">
                  <h2 class="text-sm font-semibold">æˆ‘ç™¼å¸ƒçš„ä»»å‹™</h2>
                  <div class="flex gap-2">
                    <button
                      id="btn-create-mission"
                      class="px-3 py-1 text-xs rounded bg-green-600 text-white hover:bg-green-700"
                    >
                      æ–°å¢ä»»å‹™
                    </button>
                    <!-- <button
                      id="btn-create-demo-mission"
                      class="px-3 py-1 text-xs rounded bg-blue-600 text-white hover:bg-blue-700"
                    >
                      æ–°å¢ç¤ºç¯„ä»»å‹™
                    </button> -->
                  </div>
                </div>

                ${
                  myMissions.length === 0
                    ? `<p class="text-sm text-gray-500">ä½ å°šæœªç™¼å¸ƒä»»ä½•ä»»å‹™ï¼Œå…ˆå»ºç«‹ä¸€å€‹ç¤ºç¯„ä»»å‹™è©¦è©¦ã€‚</p>`
                    : `
                  <div class="space-y-3">
                    ${myMissions
                      .sort((a, b) => {
                        // å·²å®Œæˆçš„ä»»å‹™æ’åœ¨æœ€å¾Œ
                        if (a.status === "completed" && b.status !== "completed") return 1;
                        if (a.status !== "completed" && b.status === "completed") return -1;
                        // å…¶ä»–ä»»å‹™ä¿æŒåŸæœ‰é †åº
                        return 0;
                      })
                      .map((m) => {
                        const editEnabled = canEditMission(m, currentUser.id);
                        const closeEnabled = canCloseMission(m, currentUser.id);

                        const statusColor =
                          m.status === "open"
                            ? "bg-green-100 text-green-700"
                            : m.status === "closed"
                            ? "bg-yellow-100 text-yellow-700"
                            : "bg-gray-200 text-gray-700";

                        return `
                          <div class="border rounded-lg p-3 flex flex-col gap-2">
                            <div class="flex flex-wrap items-center justify-between gap-2">
                              <div class="flex items-center gap-2">
                                <span class="font-semibold">${m.title || "æœªå‘½åä»»å‹™"}</span>
                                <span class="text-xs px-2 py-0.5 rounded-full ${statusColor}">
                                  ${m.status}
                                </span>
                              </div>
                              <div class="text-xs text-gray-400">
                                ç™¼å¸ƒæ™‚é–“ï¼š${
                                  m.postedAt ? new Date(m.postedAt).toLocaleString() : "æœªçŸ¥"
                                }
                              </div>
                            </div>
                            <div class="text-sm text-gray-600 flex flex-wrap gap-3">
                              <span>åœ°é»ï¼š${m.location || "æœªå¡«å¯«"}</span>
                              <span>ç·Šæ€¥ç¨‹åº¦ï¼š${m.urgency || "æœªè¨­å®š"}</span>
                              <span>å·²æ¥å—ï¼š${m.acceptedCount || 0} / ${m.requiredVolunteers || 0}</span>
                            </div>
                            <div class="text-xs text-gray-500">
                              æ‰€éœ€èƒ½åŠ›ï¼š${m.skills || "æœªè¨­å®š"} | é ˆè‡ªå‚™å·¥å…·ï¼š${m.requiredTools || "ç„¡"}
                            </div>
                            <div class="flex flex-wrap gap-2">
                              <button
                                class="px-3 py-1 text-xs rounded bg-gray-100 hover:bg-gray-200"
                                data-action="detail"
                                data-id="${m.id}"
                              >
                                æŸ¥çœ‹è©³ç´°ï¼†å¿—å·¥åå–®
                              </button>

                              ${
                                editEnabled
                                  ? `
                                    <button
                                      class="px-3 py-1 text-xs rounded bg-blue-600 text-white hover:bg-blue-700"
                                      data-action="edit"
                                      data-id="${m.id}"
                                    >
                                      âœï¸ ç·¨è¼¯
                                    </button>
                                  `
                                  : `
                                    <button
                                      class="px-3 py-1 text-xs rounded bg-gray-300 text-gray-600 cursor-not-allowed"
                                      disabled
                                    >
                                      ğŸ”’ ç„¡æ³•ç·¨è¼¯
                                    </button>
                                  `
                              }

                              ${
                                closeEnabled
                                  ? `
                                    <button
                                      class="px-3 py-1 text-xs rounded bg-red-600 text-white hover:bg-red-700"
                                      data-action="close"
                                      data-id="${m.id}"
                                    >
                                      é—œé–‰ä»»å‹™
                                    </button>
                                  `
                                  : m.status === "closed" && m.postedBy === currentUser.id
                                  ? `
                                    <button
                                      class="px-3 py-1 text-xs rounded bg-green-600 text-white hover:bg-green-700"
                                      data-action="open"
                                      data-id="${m.id}"
                                    >
                                      é–‹å•Ÿä»»å‹™
                                    </button>
                                  `
                                  : ""
                              }

                              ${
                                (m.status === "open" || m.status === "closed") && m.postedBy === currentUser.id
                                  ? `
                                    <button
                                      class="px-3 py-1 text-xs rounded bg-blue-600 text-white hover:bg-blue-700"
                                      data-action="complete"
                                      data-id="${m.id}"
                                    >
                                      å®Œæˆä»»å‹™
                                    </button>
                                  `
                                  : ""
                              }
                            </div>
                          </div>
                        `;
                      })
                      .join("")}
                  </div>
                `
                }
              </section>
            </main>
          </div>
        </div>
      `;

      // ç¶å®šäº‹ä»¶
      const btnBack = $("btn-back-role");
      const btnGoVolunteer = $("btn-go-volunteer");
      // const btnCreate = $("btn-create-demo-mission");
      const btnCreateMission = $("btn-create-mission");
      const btnNotifications = $("btn-notifications");

      if (btnBack) {
        btnBack.onclick = () => navigateTo("roleSelect");
      }
      if (btnGoVolunteer) {
        btnGoVolunteer.onclick = () => {
          currentUser = USERS.volunteer;
          navigateTo("volunteerProfileForm");
        };
      }
      // if (btnCreate) {
      //   btnCreate.onclick = () => {
      //     createDemoMissions();
      //     renderPublisherDashboard();
      //   };
      // }
      if (btnCreateMission) {
        btnCreateMission.onclick = () => navigateTo("createMissionForm");
      }
      if (btnNotifications) {
        btnNotifications.onclick = () => {
          markAllNotificationsRead(currentUser.id);
          renderPublisherDashboard();
        };
      }

      // å¡ç‰‡ä¸Šçš„æŒ‰éˆ•äº‹ä»¶
      const container = app;
      const buttons = container.querySelectorAll("[data-action]");
      buttons.forEach((btn) => {
        const action = btn.getAttribute("data-action");
        const id = btn.getAttribute("data-id");
        btn.addEventListener("click", () => {
          const mission = getMissionById(id);
          if (!mission) return;

          if (action === "detail") {
            navigateTo("publisherMissionDetail", { mission });
          } else if (action === "edit") {
            if (!canEditMission(mission, currentUser.id)) {
              alert("ä»»å‹™ç‹€æ…‹å·²è®Šæ›´æˆ–å·²é¡æ»¿ï¼Œç„¡æ³•ç·¨è¼¯");
              renderPublisherDashboard();
              return;
            }
            navigateTo("editMissionForm", { mission });
          } else if (action === "close") {
            if (!canCloseMission(mission, currentUser.id)) {
              alert("ä»»å‹™ç‹€æ…‹å·²è®Šæ›´ï¼Œç„¡æ³•é—œé–‰");
              renderPublisherDashboard();
              return;
            }
            if (!confirm("ç¢ºå®šè¦é—œé–‰æ­¤ä»»å‹™ï¼Ÿé—œé–‰å¾Œå¿—å·¥ç«¯ä¸å¯å†æ¥æ­¤ä»»å‹™ã€‚")) return;
            updateMission(mission.id, { status: "closed" });
            renderPublisherDashboard();
          } else if (action === "open") {
            if (!canOpenMission(mission, currentUser.id)) {
              alert("ä»»å‹™ç‹€æ…‹å·²è®Šæ›´ï¼Œç„¡æ³•é–‹å•Ÿ");
              renderPublisherDashboard();
              return;
            }
            if (!confirm("ç¢ºå®šè¦é‡æ–°é–‹å•Ÿæ­¤ä»»å‹™å—ï¼Ÿ")) return;
            updateMission(mission.id, { status: "open" });
            renderPublisherDashboard();
          } else if (action === "complete") {
            if (!canCompleteMission(mission, currentUser.id)) {
              alert("ä»»å‹™ç‹€æ…‹å·²è®Šæ›´ï¼Œç„¡æ³•å®Œæˆ");
              renderPublisherDashboard();
              return;
            }
            if (!confirm("ç¢ºå®šè¦å°‡æ­¤ä»»å‹™æ¨™è¨˜ç‚ºå·²å®Œæˆï¼Ÿ")) return;
            updateMission(mission.id, { status: "completed" });
            renderPublisherDashboard();
          }
        });
      });

      renderNotificationBadge();
    }

    /************************************************************
     * 8. ä»»å‹™è©³ç´°é ï¼ˆå«å¿—å·¥åå–®ï¼‰
     ************************************************************/

    function renderPublisherMissionDetail(mission) {
      console.log("Rendering publisher mission detail"); // é™¤éŒ¯
      const app = $("app");
      const volunteers = getAcceptsByMission(mission.id);

      app.innerHTML = `
        <div class="min-h-screen bg-slate-100 flex items-center justify-center">
          <div class="w-[390px] bg-white rounded-xl shadow-lg p-8 space-y-6">
            <div class="flex items-center justify-between">
              <h1 class="text-xl font-bold">ä»»å‹™è©³ç´°è³‡è¨Š</h1>
              <button
                id="btn-back-dashboard"
                class="px-3 py-1 text-sm rounded bg-gray-200 hover:bg-gray-300"
              >
                â† å›åˆ°ä»»å‹™åˆ—è¡¨
              </button>
            </div>

            <section class="bg-white border rounded-lg p-4 space-y-2">
              <div class="flex flex-wrap items-center justify-between gap-2">
                <div class="flex flex-wrap items-center gap-2">
                  <span class="text-lg font-semibold">${mission.title || "æœªå‘½åä»»å‹™"}</span>
                  <span class="text-xs px-2 py-0.5 rounded-full ${
                    mission.status === "open"
                      ? "bg-green-100 text-green-700"
                      : mission.status === "closed"
                      ? "bg-yellow-100 text-yellow-700"
                      : "bg-gray-200 text-gray-700"
                  }">
                    ${mission.status === "open" ? "é–‹æ”¾ä¸­" : mission.status === "closed" ? "å·²é—œé–‰" : mission.status}
                  </span>
                </div>
                <div class="flex gap-2">
                  ${
                    canCloseMission(mission, currentUser.id)
                      ? `<button
                          class="px-3 py-1 text-xs rounded bg-red-600 text-white hover:bg-red-700"
                          onclick="handleMissionStatusChange('${mission.id}', 'close')"
                        >
                          é—œé–‰ä»»å‹™
                        </button>`
                      : ""
                  }
                  ${
                    canOpenMission(mission, currentUser.id)
                      ? `<button
                          class="px-3 py-1 text-xs rounded bg-green-600 text-white hover:bg-green-700"
                          onclick="handleMissionStatusChange('${mission.id}', 'open')"
                        >
                          é–‹å•Ÿä»»å‹™
                        </button>`
                      : ""
                  }
                  ${
                    canCompleteMission(mission, currentUser.id)
                      ? `<button
                          class="px-3 py-1 text-xs rounded bg-blue-600 text-white hover:bg-blue-700"
                          onclick="handleMissionStatusChange('${mission.id}', 'completed')"
                        >
                          å®Œæˆä»»å‹™
                        </button>`
                      : ""
                  }
                  <button
                    class="px-3 py-1 text-xs rounded bg-purple-600 text-white hover:bg-purple-700"
                    onclick="navigateTo('missionChat', { mission: ${JSON.stringify(mission).replace(/"/g, '&quot;')} })"
                  >
                    ğŸ’¬ èŠå¤©å®¤
                  </button>
                </div>
              </div>
              <div class="text-sm text-gray-600">
                <div>ğŸ‘¤ ç™¼å¸ƒè€…ï¼š${getUserNameById(mission.postedBy)}</div>
                <div>åœ°é»ï¼š${mission.location || "æœªå¡«å¯«"}</div>
                <div>ç·Šæ€¥ç¨‹åº¦ï¼š${mission.urgency || "æœªè¨­å®š"}</div>
                <div>å·²æ¥å—ï¼š${mission.acceptedCount || 0} / ${mission.requiredVolunteers || 0}</div>
                <div>ç™¼å¸ƒæ™‚é–“ï¼š${
                  mission.postedAt ? new Date(mission.postedAt).toLocaleString() : "æœªçŸ¥"
                }</div>
              </div>
              ${
                mission.location && mission.location !== "æœªå¡«å¯«"
                  ? `<div class="mt-4">
                      <div class="text-sm font-medium text-gray-700 mb-2">ğŸ“ åœ°é»åœ°åœ–</div>
                      ${generateMapHtml(mission.location, "300")}
                    </div>`
                  : ""
              }
              <div class="text-sm text-gray-700">
                <div class="font-medium">ä»»å‹™æè¿°ï¼š</div>
                <p>${mission.description || "â€”"}</p>
              </div>
              <div class="text-sm text-gray-700">
                <div class="font-medium">æ‰€éœ€èƒ½åŠ›ï¼š</div>
                <p>${mission.skills || "æœªè¨­å®š"}</p>
              </div>
              <div class="text-sm text-gray-700">
                <div class="font-medium">é ˆè‡ªå‚™å·¥å…·ï¼š</div>
                <p>${mission.requiredTools || "ç„¡"}</p>
              </div>
            </section>

            <section class="bg-white border rounded-lg p-4">
              <div class="flex items-center justify-between mb-2">
                <h2 class="text-sm font-semibold">å·²æ¥å—å¿—å·¥åå–®</h2>
                <span class="text-xs text-gray-500">
                  å…± ${volunteers.length} äºº
                </span>
              </div>

              ${
                volunteers.length === 0
                  ? `<p class="text-sm text-gray-500">ç›®å‰å°šç„¡å¿—å·¥æ¥å—æ­¤ä»»å‹™ã€‚</p>`
                  : `
                <div class="space-y-2">
                  ${volunteers
                    .map(
                      (v) => {
                        const volunteerProfile = getProfileById(v.volunteerId);
                        return `
                    <div class="border rounded px-3 py-2 text-sm">
                      <div class="flex flex-col space-y-1">
                        <div class="flex items-center justify-between">
                          <div class="font-medium">${v.volunteerName || v.volunteerId}</div>
                          <div class="text-xs text-gray-600">
                            å¿—å·¥ IDï¼š${v.volunteerId}
                          </div>
                        </div>
                        <div class="text-xs text-gray-500">
                          æ¥å—æ™‚é–“ï¼š${
                            v.acceptedAt ? new Date(v.acceptedAt).toLocaleString() : "æœªçŸ¥"
                          }
                        </div>
                        <div class="text-xs text-gray-700">
                          <div class="font-medium">è¯çµ¡æ–¹å¼ï¼š</div>
                          <div>ğŸ“± ${volunteerProfile?.phone || "æœªæä¾›"}</div>
                          <div>ğŸ“ ${volunteerProfile?.location || "æœªæä¾›"}</div>
                        </div>
                        ${volunteerProfile?.bio ? `
                        <div class="text-xs text-gray-600 mt-1">
                          <div class="font-medium">è‡ªæˆ‘ä»‹ç´¹ï¼š</div>
                          <p class="text-xs">${volunteerProfile.bio}</p>
                        </div>
                        ` : ''}
                        <div class="flex justify-end mt-2">
                          <button
                            class="px-2 py-1 text-xs rounded bg-red-500 text-white hover:bg-red-600"
                            onclick="removeVolunteerFromMission('${mission.id}', '${v.volunteerId}')"
                          >
                            ç§»é™¤å¿—å·¥
                          </button>
                        </div>
                      </div>
                    </div>
                  `;
                      }
                    )
                    .join("")}
                </div>
              `
              }
            </section>
          </div>
        </div>
      `;

      const btnBack = $("btn-back-dashboard");
      if (btnBack) {
        btnBack.onclick = () => navigateTo("publisherDashboard");
      }
    }

    /************************************************************
     * 9. æ–°å¢ä»»å‹™é 
     ************************************************************/

    function renderCreateMissionForm() {
      console.log("Rendering create mission form"); // é™¤éŒ¯
      const app = $("app");
      app.innerHTML = `
        <div class="min-h-screen bg-slate-100 flex items-center justify-center">
          <div class="w-[390px] bg-white rounded-xl shadow-lg p-8 space-y-6">
            <div class="flex items-center justify-between mb-4">
              <h1 class="text-xl font-bold">æ–°å¢ä»»å‹™</h1>
              <button
                id="btn-back-dashboard"
                class="px-3 py-1 text-sm rounded bg-gray-200 hover:bg-gray-300"
              >
                â† å›åˆ°ä»»å‹™åˆ—è¡¨
              </button>
            </div>

            <form id="create-mission-form" class="bg-white border rounded-lg p-4 space-y-4">
              <div>
                <label class="block text-sm font-medium mb-1">ä»»å‹™åç¨±</label>
                <input
                  type="text"
                  name="title"
                  class="w-full border rounded px-3 py-2 text-sm"
                  required
                />
              </div>

              <div>
                <label class="block text-sm font-medium mb-1">è¯çµ¡é›»è©±</label>
                <input
                  type="tel"
                  name="contactPhone"
                  class="w-full border rounded px-3 py-2 text-sm"
                />
              </div>

              <div>
                <label class="block text-sm font-medium mb-1">ä»»å‹™æè¿°</label>
                <textarea
                  name="description"
                  rows="4"
                  class="w-full border rounded px-3 py-2 text-sm"
                ></textarea>
              </div>

              <div>
                <label class="block text-sm font-medium mb-1">ä»»å‹™åœ°é»</label>
                <input
                  type="text"
                  name="location"
                  class="w-full border rounded px-3 py-2 text-sm"
                  placeholder="ä¾‹å¦‚ï¼šå°åŒ—å¸‚å¤§å®‰å€ç½å®³æ‡‰è®Šä¸­å¿ƒ"
                />
              </div>

              <div>
                <label class="block text-sm font-medium mb-1">ç·Šæ€¥ç¨‹åº¦</label>
                <select
                  name="urgency"
                  class="w-full border rounded px-3 py-2 text-sm"
                >
                  <option value="low">ä½</option>
                  <option value="medium" selected>ä¸­</option>
                  <option value="high">é«˜</option>
                </select>
              </div>

              <div>
                <label class="block text-sm font-medium mb-1">
                  æ‰€éœ€èƒ½åŠ›
                  <span class="text-xs text-gray-500">
                    ï¼ˆå‹¾é¸ä»»å‹™æ‰€éœ€çš„æŠ€èƒ½ï¼Œç”¨æ–¼è‡ªå‹•åŒ¹é…å¿—å·¥ï¼‰
                  </span>
                </label>
                <div class="grid grid-cols-2 gap-2">
                  <label class="flex items-center">
                    <input
                      type="checkbox"
                      name="skills"
                      value="æœ‰æ„é¡˜çš†å¯"
                      class="mr-2"
                    />
                    æœ‰æ„é¡˜çš†å¯
                  </label>
                  ${["æ¬é‹", "æ°´é›»", "çƒ¹é£ª", "é§•é§›", "é†«ç™‚", "ç…§è­·", "å‹˜æŸ¥", "æ–‡æ›¸"].map(skill => `
                    <label class="flex items-center">
                      <input
                        type="checkbox"
                        name="skills"
                        value="${skill}"
                        class="mr-2"
                      />
                      ${skill}
                    </label>
                  `).join('')}
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium mb-1">éœ€æ±‚äººæ•¸</label>
                <input
                  type="number"
                  name="requiredVolunteers"
                  class="w-full border rounded px-3 py-2 text-sm"
                  min="1"
                  value="1"
                  required
                />
              </div>

              <div>
                <label class="block text-sm font-medium mb-1">
                  é ˆè‡ªå‚™å·¥å…·
                  <span class="text-xs text-gray-500">
                    ï¼ˆå‹¾é¸ä»»å‹™æ‰€éœ€çš„å·¥å…·ï¼Œå¿—å·¥éœ€è‡ªè¡Œæº–å‚™ï¼‰
                  </span>
                </label>
                <div class="grid grid-cols-2 gap-2">
                  ${["éŸå­", "æ‰‹æ¨è»Š", "æ©Ÿè»Š", "è²¨è»Š", "å…¶ä»–", "ç„¡ç‰¹æ®Šå·¥å…·"].map(tool => `
                    <label class="flex items-center">
                      <input
                        type="checkbox"
                        name="requiredTools"
                        value="${tool}"
                        class="mr-2"
                      />
                      ${tool}
                    </label>
                  `).join('')}
                </div>
              </div>

              <div class="flex gap-3 pt-2">
                <button
                  type="submit"
                  class="px-4 py-2 text-sm rounded bg-blue-600 text-white hover:bg-blue-700"
                >
                  æ–°å¢ä»»å‹™
                </button>
                <button
                  type="button"
                  id="btn-cancel-create"
                  class="px-4 py-2 text-sm rounded bg-gray-200 hover:bg-gray-300"
                >
                  å–æ¶ˆ
                </button>
              </div>
            </form>
          </div>
        </div>
      `;

      const btnBack = $("btn-back-dashboard");
      const btnCancel = $("btn-cancel-create");
      const form = $("create-mission-form");

      if (btnBack) {
        btnBack.onclick = () => navigateTo("publisherDashboard");
      }
      if (btnCancel) {
        btnCancel.onclick = () => navigateTo("publisherDashboard");
      }
      if (form) {
        form.onsubmit = (e) => handleCreateMissionSubmit(e);
      }
    }

    function handleCreateMissionSubmit(event) {
      event.preventDefault();

      const form = event.target;
      // è™•ç†å‹¾é¸æ¡†çš„æŠ€èƒ½
      const selectedSkills = Array.from(form.skills || [])
        .filter(checkbox => checkbox.checked)
        .map(checkbox => checkbox.value);
      // è™•ç†å‹¾é¸æ¡†çš„æ‰€éœ€å·¥å…·
      const selectedRequiredTools = Array.from(form.requiredTools || [])
        .filter(checkbox => checkbox.checked)
        .map(checkbox => checkbox.value);

      const mission = {
        id: genId("mission"),
        title: form.title.value.trim(),
        description: form.description.value.trim(),
        location: form.location.value.trim(),
        urgency: form.urgency.value,
        skills: selectedSkills.join('ã€'), // å°‡å‹¾é¸çš„æŠ€èƒ½ç”¨é “è™Ÿé€£æ¥
        requiredTools: selectedRequiredTools.join('ã€'), // å°‡å‹¾é¸çš„å·¥å…·ç”¨é “è™Ÿé€£æ¥
        requiredVolunteers: Number(form.requiredVolunteers.value.trim()),
        acceptedCount: 0,
        postedBy: currentUser.id,
        postedAt: new Date().toISOString(),
        status: "open",
        contactPhone: form.contactPhone.value.trim()
      };

      addMission(mission);
      alert("ä»»å‹™æ–°å¢æˆåŠŸï¼");
      navigateTo("publisherDashboard");
    }

    /************************************************************
     * 10. ç·¨è¼¯ä»»å‹™é 
     ************************************************************/

    function renderEditMissionForm(mission) {
      console.log("Rendering edit mission form"); // é™¤éŒ¯
      const app = $("app");
      app.innerHTML = `
        <div class="min-h-screen bg-slate-100 flex items-center justify-center">
          <div class="w-[390px] bg-white rounded-xl shadow-lg p-8 space-y-6">
            <div class="flex items-center justify-between mb-4">
              <h1 class="text-xl font-bold">ç·¨è¼¯ä»»å‹™</h1>
              <button
                id="btn-back-dashboard"
                class="px-3 py-1 text-sm rounded bg-gray-200 hover:bg-gray-300"
              >
                â† å›åˆ°ä»»å‹™åˆ—è¡¨
              </button>
            </div>

            <form id="edit-mission-form" class="bg-white border rounded-lg p-4 space-y-4">
              <div>
                <label class="block text-sm font-medium mb-1">ä»»å‹™åç¨±</label>
                <input
                  type="text"
                  name="title"
                  class="w-full border rounded px-3 py-2 text-sm"
                  value="${mission.title || ""}"
                  required
                />
              </div>

              <div>
                <label class="block text-sm font-medium mb-1">è¯çµ¡é›»è©±</label>
                <input
                  type="tel"
                  name="contactPhone"
                  class="w-full border rounded px-3 py-2 text-sm"
                  value="${mission.contactPhone || ""}"
                />
              </div>

              <div>
                <label class="block text-sm font-medium mb-1">ä»»å‹™æè¿°</label>
                <textarea
                  name="description"
                  rows="4"
                  class="w-full border rounded px-3 py-2 text-sm"
                >${mission.description || ""}</textarea>
              </div>

              <div>
                <label class="block text-sm font-medium mb-1">ä»»å‹™åœ°é»</label>
                <input
                  type="text"
                  name="location"
                  class="w-full border rounded px-3 py-2 text-sm"
                  value="${mission.location || ""}"
                  placeholder="ä¾‹å¦‚ï¼šå°åŒ—å¸‚å¤§å®‰å€ç½å®³æ‡‰è®Šä¸­å¿ƒ"
                />
              </div>

              <div>
                <label class="block text-sm font-medium mb-1">ç·Šæ€¥ç¨‹åº¦</label>
                <select
                  name="urgency"
                  class="w-full border rounded px-3 py-2 text-sm"
                >
                  <option value="low" ${mission.urgency === "low" ? "selected" : ""}>ä½</option>
                  <option value="medium" ${!mission.urgency || mission.urgency === "medium" ? "selected" : ""}>ä¸­</option>
                  <option value="high" ${mission.urgency === "high" ? "selected" : ""}>é«˜</option>
                </select>
              </div>

              <div>
                <label class="block text-sm font-medium mb-1">
                  æ‰€éœ€èƒ½åŠ› / å·¥å…·
                  <span class="text-xs text-gray-500">
                    ï¼ˆå‹¾é¸ä»»å‹™æ‰€éœ€çš„æŠ€èƒ½ï¼Œç”¨æ–¼è‡ªå‹•åŒ¹é…å¿—å·¥ï¼‰
                  </span>
                </label>
                <div class="grid grid-cols-2 gap-2">
                  <label class="flex items-center">
                    <input
                      type="checkbox"
                      name="skills"
                      value="æœ‰æ„é¡˜çš†å¯"
                      class="mr-2"
                      ${((mission.skills || "").split(/[ã€,\s]+/).filter(s => s.trim()).includes("æœ‰æ„é¡˜çš†å¯")) ? 'checked' : ''}
                    />
                    æœ‰æ„é¡˜çš†å¯
                  </label>
                  ${["æ¬é‹", "æ°´é›»", "çƒ¹é£ª", "é§•é§›", "é†«ç™‚", "ç…§è­·", "å‹˜æŸ¥", "æ–‡æ›¸"].map(skill => {
                    const currentSkills = (mission.skills || "").split(/[ã€,\s]+/).filter(s => s.trim());
                    const isChecked = currentSkills.includes(skill);
                    return `
                      <label class="flex items-center">
                        <input
                          type="checkbox"
                          name="skills"
                          value="${skill}"
                          class="mr-2"
                          ${isChecked ? 'checked' : ''}
                        />
                        ${skill}
                      </label>
                    `;
                  }).join('')}
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium mb-1">
                  éœ€æ±‚äººæ•¸
                  <span class="text-xs text-gray-500">
                    ï¼ˆä¸å¯å°æ–¼å·²æ¥å—äººæ•¸ï¼š${mission.acceptedCount || 0}ï¼‰
                  </span>
                </label>
                <input
                  type="number"
                  name="requiredVolunteers"
                  class="w-full border rounded px-3 py-2 text-sm"
                  min="${mission.acceptedCount || 0}"
                  value="${mission.requiredVolunteers || 0}"
                  required
                />
              </div>

              <div>
                <label class="block text-sm font-medium mb-1">
                  é ˆè‡ªå‚™å·¥å…·
                  <span class="text-xs text-gray-500">
                    ï¼ˆå‹¾é¸ä»»å‹™æ‰€éœ€çš„å·¥å…·ï¼Œå¿—å·¥éœ€è‡ªè¡Œæº–å‚™ï¼‰
                  </span>
                </label>
                <div class="grid grid-cols-2 gap-2">
                  ${["éŸå­", "æ‰‹æ¨è»Š", "æ©Ÿè»Š", "è²¨è»Š", "å…¶ä»–", "ç„¡ç‰¹æ®Šå·¥å…·"].map(tool => {
                    const currentTools = (mission.requiredTools || "").split(/[ã€,\s]+/).filter(s => s.trim());
                    const isChecked = currentTools.includes(tool);
                    return `
                      <label class="flex items-center">
                        <input
                          type="checkbox"
                          name="requiredTools"
                          value="${tool}"
                          class="mr-2"
                          ${isChecked ? 'checked' : ''}
                        />
                        ${tool}
                      </label>
                    `;
                  }).join('')}
                </div>
              </div>

              <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-xs text-gray-600 bg-gray-50 border rounded p-3">
                <div>
                  <div class="font-medium">ç™¼å¸ƒè€…</div>
                  <div>${mission.postedBy}</div>
                </div>
                <div>
                  <div class="font-medium">å·²æ¥å—äººæ•¸</div>
                  <div>${mission.acceptedCount || 0}</div>
                </div>
                <div>
                  <div class="font-medium">ç™¼å¸ƒæ™‚é–“</div>
                  <div>${mission.postedAt ? new Date(mission.postedAt).toLocaleString() : "æœªçŸ¥"}</div>
                </div>
                <div>
                  <div class="font-medium">ç›®å‰ç‹€æ…‹</div>
                  <div>${mission.status}</div>
                </div>
              </div>

              <div class="flex gap-3 pt-2">
                <button
                  type="submit"
                  class="px-4 py-2 text-sm rounded bg-blue-600 text-white hover:bg-blue-700"
                >
                  å„²å­˜ä¿®æ”¹
                </button>
                <button
                  type="button"
                  id="btn-cancel-edit"
                  class="px-4 py-2 text-sm rounded bg-gray-200 hover:bg-gray-300"
                >
                  å–æ¶ˆ
                </button>
              </div>
            </form>
          </div>
        </div>
      `;

      const btnBack = $("btn-back-dashboard");
      const btnCancel = $("btn-cancel-edit");
      const form = $("edit-mission-form");

      if (btnBack) {
        btnBack.onclick = () => navigateTo("publisherDashboard");
      }
      if (btnCancel) {
        btnCancel.onclick = () => navigateTo("publisherDashboard");
      }
      if (form) {
        form.onsubmit = (e) => handleEditMissionSubmit(e, mission);
      }
    }

    function handleEditMissionSubmit(event, mission) {
      event.preventDefault();

      // å†æª¢æŸ¥ä¸€æ¬¡æ¬Šé™
      if (!canEditMission(mission, currentUser.id)) {
        alert("ä»»å‹™ç‹€æ…‹å·²è®Šæ›´æˆ–å·²é¡æ»¿ï¼Œç„¡æ³•ç·¨è¼¯");
        navigateTo("publisherDashboard");
        return;
      }

      const form = event.target;
      const newRequired = Number(form.requiredVolunteers.value.trim());
      const acceptedCount = mission.acceptedCount || 0;

      if (newRequired < acceptedCount) {
        alert("éœ€æ±‚äººæ•¸ä¸å¯å°æ–¼å·²æ¥å—äººæ•¸");
        return;
      }

      // è™•ç†å‹¾é¸æ¡†çš„æŠ€èƒ½
      const selectedSkills = Array.from(form.skills || [])
        .filter(checkbox => checkbox.checked)
        .map(checkbox => checkbox.value);
      // è™•ç†å‹¾é¸æ¡†çš„æ‰€éœ€å·¥å…·
      const selectedRequiredTools = Array.from(form.requiredTools || [])
        .filter(checkbox => checkbox.checked)
        .map(checkbox => checkbox.value);

      const patch = {
        title: form.title.value.trim(),
        contactPhone: form.contactPhone.value.trim(),
        description: form.description.value.trim(),
        location: form.location.value.trim(),
        urgency: form.urgency.value,
        skills: selectedSkills.join('ã€'), // å°‡å‹¾é¸çš„æŠ€èƒ½ç”¨é “è™Ÿé€£æ¥
        requiredTools: selectedRequiredTools.join('ã€'), // å°‡å‹¾é¸çš„å·¥å…·ç”¨é “è™Ÿé€£æ¥
        requiredVolunteers: newRequired,
        updatedAt: new Date().toISOString()
      };

      updateMission(mission.id, patch);
      alert("æ›´æ–°æˆåŠŸ");
      navigateTo("publisherDashboard");
    }

    /************************************************************
     * 10. å¿—å·¥ç«¯ï¼šä»»å‹™åˆ—è¡¨ + æ¥å—ä»»å‹™ + è‡ªå‹•åŒ¹é…
     ************************************************************/

    function renderVolunteerMissionList() {
      console.log("Rendering volunteer mission list"); // é™¤éŒ¯
      const app = $("app");
      const allMissions = getMissions().filter(
        (m) =>
          m.status === "open" &&
          (m.acceptedCount || 0) < (m.requiredVolunteers || 0)
      );
      const profile = getProfileById(currentUser.id);
      const recommended = profile ? getRecommendedMissions(profile, allMissions) : [];
      const sortedMissions = allMissions.sort((a, b) => {
        const scoreA = calculateMatchScore(a, profile);
        const scoreB = calculateMatchScore(b, profile);
        return scoreB - scoreA; // åŒ¹é…åˆ†æ•¸é«˜çš„å„ªå…ˆ
      });

      // ç²å–å¿—å·¥å·²æ¥å—çš„ä»»å‹™
      const acceptedMissions = getMissions().filter(mission => {
        const accepts = getAcceptsByMission(mission.id);
        return accepts.some(accept => accept.volunteerId === currentUser.id) && mission.status !== "completed";
      });

      // ç²å–å¿—å·¥å·²å®Œæˆçš„ä»»å‹™
      const completedMissions = getMissions().filter(mission => {
        const accepts = getAcceptsByMission(mission.id);
        return mission.status === "completed" && accepts.some(accept => accept.volunteerId === currentUser.id);
      });

      app.innerHTML = `
        <div class="min-h-screen bg-slate-100 flex items-center justify-center">
          <div class="w-[390px] bg-white rounded-xl shadow-lg p-8 space-y-6">
            <header class="bg-white shadow-sm">
              <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
                <div>
                  <h1 class="text-xl font-bold">å¿—å·¥ä»»å‹™åˆ—è¡¨</h1>
                  <p class="text-xs text-gray-500">
                    ç›®å‰èº«ä»½ï¼š${currentUser.name}ï¼ˆ${currentUser.id}ï¼‰
                  </p>
                </div>
                <div class="flex items-center gap-4 text-sm">
                  <button id="btn-edit-profile" class="text-blue-600 hover:text-blue-900 font-medium">
                    ç·¨è¼¯å±¥æ­·
                  </button>
                  <button id="btn-go-publisher" class="text-gray-600 hover:text-gray-900">
                    åˆ‡æ›ç‚ºä»»å‹™ç™¼å¸ƒè€…
                  </button>
                  <button id="btn-back-role" class="text-gray-600 hover:text-gray-900">
                    è§’è‰²é¸æ“‡
                  </button>
                </div>
              </div>
            </header>

            <main class="max-w-6xl mx-auto px-4 py-4 space-y-4">
              <!-- æ¨è–¦ä»»å‹™å€å¡Š -->
              ${
                profile
                  ? recommended.length > 0
                    ? `
                      <section class="bg-emerald-50 border border-emerald-200 rounded-lg p-3">
                        <div class="flex items-center justify-between mb-2">
                          <h2 class="text-sm font-semibold text-emerald-700">ğŸ¯ æ¨è–¦ä»»å‹™ï¼ˆåŸºæ–¼ä½ çš„æŠ€èƒ½ï¼‰</h2>
                          <span class="text-xs text-emerald-600">
                            å…± ${recommended.length} å€‹åŒ¹é…
                          </span>
                        </div>
                        <div class="space-y-2">
                          ${recommended
                            .map(
                              ({ mission, score }) => `
                            <div class="border rounded-lg p-2 bg-white">
                              <div class="font-semibold text-sm">${mission.title || "æœªå‘½åä»»å‹™"}</div>
                              <div class="text-xs text-gray-600">åŒ¹é…åˆ†æ•¸ï¼š${score} | åœ°é»ï¼š${mission.location || "æœªå¡«å¯«"} | ç·Šæ€¥ç¨‹åº¦ï¼š${mission.urgency || "æœªè¨­å®š"}</div>
                              <div class="text-xs text-gray-500">æ‰€éœ€èƒ½åŠ›ï¼š${mission.skills || "æœªè¨­å®š"} | é ˆè‡ªå‚™å·¥å…·ï¼š${mission.requiredTools || "ç„¡"}</div>
                              <button
                                class="mt-1 px-2 py-1 text-xs rounded bg-emerald-600 text-white hover:bg-emerald-700"
                                data-action="accept"
                                data-id="${mission.id}"
                              >
                                æ¥å—ä»»å‹™
                              </button>
                            </div>
                          `
                            )
                            .join("")}
                        </div>
                      </section>
                    `
                    : `<p class="text-sm text-gray-500">ç›®å‰æ²’æœ‰æ¨è–¦ä»»å‹™ï¼Œè«‹æª¢æŸ¥ä½ çš„å±¥æ­·æŠ€èƒ½ã€‚</p>`
                  : `<p class="text-sm text-gray-500">è«‹å…ˆå¡«å¯«å±¥æ­·ä»¥å•Ÿç”¨è‡ªå‹•åŒ¹é…åŠŸèƒ½ã€‚</p>`
              }

              <!-- å·²æ¥å—çš„ä»»å‹™ -->
              <section class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                <div class="flex items-center justify-between mb-2">
                  <h2 class="text-sm font-semibold text-blue-700">ğŸ“‹ æˆ‘å·²æ¥å—çš„ä»»å‹™</h2>
                  <span class="text-xs text-blue-600">
                    å…± ${acceptedMissions.length} å€‹ä»»å‹™
                  </span>
                </div>
                ${
                  acceptedMissions.length === 0
                    ? `<p class="text-sm text-gray-500">ä½ å°šæœªæ¥å—ä»»ä½•ä»»å‹™ã€‚</p>`
                    : `
                    <div class="space-y-2">
                      ${acceptedMissions
                        .map((m, index) => {
                          const accepts = getAcceptsByMission(m.id);
                          const myAccept = accepts.find(a => a.volunteerId === currentUser.id);
                          return `
                          <div class="border rounded-lg p-3 bg-white">
                            <div class="flex items-center justify-between">
                              <div class="flex items-center gap-2">
                                <div class="font-semibold text-sm">${m.title || "æœªå‘½åä»»å‹™"}</div>
                                <span class="text-xs px-2 py-0.5 rounded-full ${
                                  m.status === "open"
                                    ? "bg-green-100 text-green-700"
                                    : m.status === "closed"
                                    ? "bg-red-100 text-red-700"
                                    : m.status === "completed"
                                    ? "bg-blue-100 text-blue-700"
                                    : "bg-gray-100 text-gray-700"
                                }">
                                  ${m.status === "open" ? "é–‹æ”¾ä¸­" : m.status === "closed" ? "å·²é—œé–‰" : m.status === "completed" ? "å·²å®Œæˆ" : m.status}
                                </span>
                                <span class="text-xs px-2 py-0.5 rounded-full ${
                                  m.urgency === "high"
                                    ? "bg-red-100 text-red-700"
                                    : m.urgency === "medium"
                                    ? "bg-yellow-100 text-yellow-700"
                                    : "bg-green-100 text-green-700"
                                }">
                                  ${m.urgency === "high" ? "é«˜" : m.urgency === "medium" ? "ä¸­" : "ä½"}
                                </span>
                              </div>
                              <div class="flex gap-2">
                                <button
                                  class="px-2 py-1 text-xs rounded bg-blue-600 text-white hover:bg-blue-700"
                                  onclick="toggleMissionDetail('accepted-${index}')"
                                >
                                  è©³æƒ…
                                </button>
                                <button
                                  class="px-2 py-1 text-xs rounded bg-purple-600 text-white hover:bg-purple-700"
                                  onclick="navigateTo('missionChat', { mission: ${JSON.stringify(m).replace(/"/g, '&quot;')} })"
                                >
                                  ğŸ’¬
                                </button>
                                ${
                                  m.status !== "completed"
                                    ? `<button
                                        class="px-2 py-1 text-xs rounded bg-green-600 text-white hover:bg-green-700"
                                        onclick="completeMission('${m.id}')"
                                      >
                                        å®Œæˆ
                                      </button>`
                                    : `<span class="px-2 py-1 text-xs rounded bg-gray-400 text-white">
                                        å·²å®Œæˆ
                                      </span>`
                                }
                              </div>
                            </div>
                            <div id="accepted-${index}" class="mt-3 pt-3 border-t border-gray-200" style="display:none;">
                              <div class="text-sm text-gray-600 space-y-1">
                                <div>ï¿½ ç™¼å¸ƒè€…ï¼š${getUserNameById(m.postedBy)}</div>
                                <div>ï¿½ğŸ“ åœ°é»ï¼š${m.location || "æœªå¡«å¯«"}</div>
                                <div>ğŸš¨ ç·Šæ€¥ç¨‹åº¦ï¼š${m.urgency === "high" ? "é«˜" : m.urgency === "medium" ? "ä¸­" : "ä½"}</div>
                                <div>ğŸ‘¥ éœ€æ±‚äººæ•¸ï¼š${m.acceptedCount || 0} / ${m.requiredVolunteers || 0}</div>
                                <div>ğŸ“ è¯çµ¡é›»è©±ï¼š${m.contactPhone || "æœªæä¾›"}</div>
                                <div>â° æ¥å—æ™‚é–“ï¼š${myAccept ? new Date(myAccept.acceptedAt).toLocaleString() : "æœªçŸ¥"}</div>
                                <div>ğŸ“… ç™¼å¸ƒæ™‚é–“ï¼š${m.postedAt ? new Date(m.postedAt).toLocaleString() : "æœªçŸ¥"}</div>
                              </div>
                              <div class="text-xs text-gray-700 mt-2">
                                <div class="font-medium">ä»»å‹™æè¿°ï¼š</div>
                                <p>${m.description || "ç„¡æè¿°"}</p>
                              </div>
                              ${
                                m.location && m.location !== "æœªå¡«å¯«"
                                  ? `<div class="mt-3">
                                      <div class="text-xs font-medium text-gray-700 mb-1">ğŸ“ åœ°é»åœ°åœ–</div>
                                      ${generateMapHtml(m.location, "200")}
                                    </div>`
                                  : ""
                              }
                            </div>
                          </div>
                        `;
                        })
                        .join("")}
                    </div>
                  `
                }
              </section>

              <!-- å·²å®Œæˆçš„ä»»å‹™ -->
              <section class="bg-green-50 border border-green-200 rounded-lg p-3">
                <div class="flex items-center justify-between mb-2">
                  <h2 class="text-sm font-semibold text-green-700">âœ… æˆ‘å·²å®Œæˆçš„ä»»å‹™</h2>
                  <span class="text-xs text-green-600">
                    å…± ${completedMissions.length} å€‹ä»»å‹™
                  </span>
                </div>
                ${
                  completedMissions.length === 0
                    ? `<p class="text-sm text-gray-500">ä½ å°šæœªå®Œæˆä»»ä½•ä»»å‹™ã€‚</p>`
                    : `
                    <div class="space-y-2">
                      ${completedMissions
                        .map((m, index) => {
                          const accepts = getAcceptsByMission(m.id);
                          const myAccept = accepts.find(a => a.volunteerId === currentUser.id);
                          return `
                          <div class="border rounded-lg p-3 bg-white">
                            <div class="flex items-center justify-between">
                              <div class="flex items-center gap-2">
                                <div class="font-semibold text-sm">${m.title || "æœªå‘½åä»»å‹™"}</div>
                                <span class="text-xs px-2 py-0.5 rounded-full bg-blue-100 text-blue-700">
                                  å·²å®Œæˆ
                                </span>
                                <span class="text-xs px-2 py-0.5 rounded-full ${
                                  m.urgency === "high"
                                    ? "bg-red-100 text-red-700"
                                    : m.urgency === "medium"
                                    ? "bg-yellow-100 text-yellow-700"
                                    : "bg-green-100 text-green-700"
                                }">
                                  ${m.urgency === "high" ? "é«˜" : m.urgency === "medium" ? "ä¸­" : "ä½"}
                                </span>
                              </div>
                              <div class="flex gap-2">
                                <button
                                  class="px-2 py-1 text-xs rounded bg-blue-600 text-white hover:bg-blue-700"
                                  onclick="toggleMissionDetail('completed-${index}')"
                                >
                                  è©³æƒ…
                                </button>
                                <button
                                  class="px-2 py-1 text-xs rounded bg-purple-600 text-white hover:bg-purple-700"
                                  onclick="navigateTo('missionChat', { mission: ${JSON.stringify(m).replace(/"/g, '&quot;')} })"
                                >
                                  ğŸ’¬
                                </button>
                                <span class="px-2 py-1 text-xs rounded bg-gray-400 text-white">
                                  å·²å®Œæˆ
                                </span>
                              </div>
                            </div>
                            <div id="completed-${index}" class="mt-3 pt-3 border-t border-gray-200" style="display:none;">
                              <div class="text-sm text-gray-600 space-y-1">
                                <div>ï¿½ ç™¼å¸ƒè€…ï¼š${getUserNameById(m.postedBy)}</div>
                                <div>ï¿½ğŸ“ åœ°é»ï¼š${m.location || "æœªå¡«å¯«"}</div>
                                <div>ğŸš¨ ç·Šæ€¥ç¨‹åº¦ï¼š${m.urgency === "high" ? "é«˜" : m.urgency === "medium" ? "ä¸­" : "ä½"}</div>
                                <div>ğŸ‘¥ éœ€æ±‚äººæ•¸ï¼š${m.acceptedCount || 0} / ${m.requiredVolunteers || 0}</div>
                                <div>ğŸ“ è¯çµ¡é›»è©±ï¼š${m.contactPhone || "æœªæä¾›"}</div>
                                <div>â° æ¥å—æ™‚é–“ï¼š${myAccept ? new Date(myAccept.acceptedAt).toLocaleString() : "æœªçŸ¥"}</div>
                                <div>ğŸ“… ç™¼å¸ƒæ™‚é–“ï¼š${m.postedAt ? new Date(m.postedAt).toLocaleString() : "æœªçŸ¥"}</div>
                                <div>âœ… å®Œæˆæ™‚é–“ï¼š${m.completedAt ? new Date(m.completedAt).toLocaleString() : "æœªçŸ¥"}</div>
                              </div>
                              <div class="text-xs text-gray-700 mt-2">
                                <div class="font-medium">ä»»å‹™æè¿°ï¼š</div>
                                <p>${m.description || "ç„¡æè¿°"}</p>
                              </div>
                              ${
                                m.location && m.location !== "æœªå¡«å¯«"
                                  ? `<div class="mt-3">
                                      <div class="text-xs font-medium text-gray-700 mb-1">ğŸ“ åœ°é»åœ°åœ–</div>
                                      ${generateMapHtml(m.location, "200")}
                                    </div>`
                                  : ""
                              }
                            </div>
                          </div>
                        `;
                        })
                        .join("")}
                    </div>
                  `
                }
              </section>

              <!-- æ‰€æœ‰å¯æ¥å—ä»»å‹™ -->
              <section class="bg-white border rounded-lg p-3">
                <div class="flex items-center justify-between mb-2">
                  <h2 class="text-sm font-semibold">å¯æ¥å—çš„ä»»å‹™</h2>
                  <p class="text-xs text-gray-500">
                    å·²æŒ‰åŒ¹é…åº¦æ’åº
                  </p>
                </div>

                ${
                  sortedMissions.length === 0
                    ? `<p class="text-sm text-gray-500">ç›®å‰æ²’æœ‰å¯æ¥å—çš„ä»»å‹™ã€‚</p>`
                    : `
                  <div class="space-y-3">
                    ${sortedMissions
                      .map(
                        (m) => `
                      <div class="border rounded-lg p-3 flex flex-col gap-2">
                        <div class="flex flex-wrap items-center justify-between gap-2">
                          <div class="font-semibold">${m.title || "æœªå‘½åä»»å‹™"}</div>
                          <div class="text-xs text-gray-400">
                            ç™¼å¸ƒè€…ï¼š${getUserNameById(m.postedBy)}
                          </div>
                        </div>
                        <div class="text-sm text-gray-600 flex flex-wrap gap-3">
                          <span>åœ°é»ï¼š${m.location || "æœªå¡«å¯«"}</span>
                          <span>ç·Šæ€¥ç¨‹åº¦ï¼š${m.urgency || "æœªè¨­å®š"}</span>
                          <span>å·²æ¥å—ï¼š${m.acceptedCount || 0} / ${m.requiredVolunteers || 0}</span>
                        </div>
                        <div class="text-xs text-gray-700">
                          ${m.description || "â€”" }
                        </div>
                        <div class="text-xs text-gray-600">
                          <div>æ‰€éœ€èƒ½åŠ›ï¼š${m.skills || "æœªè¨­å®š"}</div>
                          <div>é ˆè‡ªå‚™å·¥å…·ï¼š${m.requiredTools || "ç„¡"}</div>
                        </div>
                        <div>
                          <button
                            class="px-3 py-1 text-xs rounded bg-emerald-600 text-white hover:bg-emerald-700"
                            data-action="accept"
                            data-id="${m.id}"
                          >
                            æ¥å—ä»»å‹™
                          </button>
                        </div>
                      </div>
                    `
                      )
                      .join("")}
                  </div>
                `
                }
              </section>
            </main>
          </div>
        </div>
      `;

      const btnBack = $("btn-back-role");
      const btnGoPublisher = $("btn-go-publisher");
      const btnEditProfile = $("btn-edit-profile");

      if (btnBack) {
        btnBack.onclick = () => navigateTo("roleSelect");
      }
      if (btnGoPublisher) {
        btnGoPublisher.onclick = () => {
          currentUser = USERS.publisher;
          navigateTo("publisherDashboard");
        };
      }
      if (btnEditProfile) {
        btnEditProfile.onclick = () => navigateTo("volunteerProfileForm");
      }

      const container = app;
      const buttons = container.querySelectorAll("[data-action='accept']");
      buttons.forEach((btn) => {
        const id = btn.getAttribute("data-id");
        btn.addEventListener("click", () => {
          const mission = getMissionById(id);
          if (!mission) return;
          handleVolunteerAcceptMission(mission);
        });
      });
    }

    function renderMissionChat(mission) {
      console.log("Rendering mission chat"); // é™¤éŒ¯
      const app = $("app");
      const messages = getChatMessagesByMission(mission.id);

      app.innerHTML = `
        <div class="min-h-screen bg-slate-100 flex items-center justify-center">
          <div class="w-[390px] bg-white rounded-xl shadow-lg flex flex-col" style="height: 600px;">
            <!-- èŠå¤©å®¤æ¨™é¡Œ -->
            <div class="flex items-center justify-between p-4 border-b">
              <div class="flex items-center gap-2">
                <button
                  id="btn-back-chat"
                  class="text-gray-600 hover:text-gray-900"
                >
                  â†
                </button>
                <div>
                  <h1 class="text-lg font-bold">ğŸ’¬ ${mission.title || "ä»»å‹™èŠå¤©å®¤"}</h1>
                  <p class="text-xs text-gray-500">ç™¼å¸ƒè€…ï¼š${getUserNameById(mission.postedBy)} â€¢ ${messages.length} å‰‡è¨Šæ¯</p>
                </div>
              </div>
            </div>

            <!-- è¨Šæ¯åˆ—è¡¨ -->
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-3">
              ${
                messages.length === 0
                  ? `<div class="text-center text-gray-500 text-sm py-8">
                      é‚„æ²’æœ‰è¨Šæ¯ï¼Œé–‹å§‹èŠå¤©å§ï¼
                    </div>`
                  : messages.map(msg => `
                    <div class="flex ${msg.senderId === currentUser.id ? 'justify-end' : 'justify-start'}">
                      <div class="max-w-[70%] ${msg.senderId === currentUser.id ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-900'} rounded-lg px-3 py-2">
                        <div class="text-xs font-medium mb-1 ${msg.senderId === currentUser.id ? 'text-blue-100' : 'text-gray-600'}">
                          ${msg.senderName}
                        </div>
                        <div class="text-sm">${msg.content}</div>
                        <div class="text-xs ${msg.senderId === currentUser.id ? 'text-blue-200' : 'text-gray-500'} mt-1">
                          ${new Date(msg.createdAt).toLocaleTimeString()}
                        </div>
                      </div>
                    </div>
                  `).join('')
              }
            </div>

            <!-- ç™¼é€è¨Šæ¯å€åŸŸ -->
            <div class="border-t p-4">
              <div class="flex gap-2">
                <input
                  id="chat-input"
                  type="text"
                  placeholder="è¼¸å…¥è¨Šæ¯..."
                  class="flex-1 px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                  maxlength="500"
                >
                <button
                  id="btn-send-message"
                  class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-400"
                >
                  ç™¼é€
                </button>
              </div>
            </div>
          </div>
        </div>
      `;

      // ç¶å®šäº‹ä»¶
      const btnBack = $("btn-back-chat");
      const btnSend = $("btn-send-message");
      const input = $("chat-input");

      if (btnBack) {
        btnBack.onclick = () => {
          if (currentUser.role === "publisher") {
            navigateTo("publisherDashboard");
          } else {
            navigateTo("volunteerMissionList");
          }
        };
      }

      if (btnSend && input) {
        const sendMessage = () => {
          const content = input.value.trim();
          if (!content) return;

          const message = {
            id: genId("msg"),
            missionId: mission.id,
            senderId: currentUser.id,
            senderName: currentUser.name,
            content: content,
            createdAt: new Date().toISOString()
          };

          addChatMessage(message);
          input.value = "";
          renderMissionChat(mission); // é‡æ–°æ¸²æŸ“ä»¥é¡¯ç¤ºæ–°è¨Šæ¯
        };

        btnSend.onclick = sendMessage;
        input.onkeypress = (e) => {
          if (e.key === "Enter") {
            sendMessage();
          }
        };
      }

      // æ»¾å‹•åˆ°æœ€æ–°è¨Šæ¯
      setTimeout(() => {
        const messagesContainer = $("chat-messages");
        if (messagesContainer) {
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
      }, 100);
    }

    function handleVolunteerAcceptMission(mission) {
      // æª¢æŸ¥ä»»å‹™ç‹€æ…‹
      if (mission.status !== "open") {
        alert("æ­¤ä»»å‹™å·²é—œé–‰ï¼Œç„¡æ³•æ¥å—");
        renderVolunteerMissionList();
        return;
      }

      // æª¢æŸ¥æ˜¯å¦å·²é¡æ»¿
      const currentAccepts = getAcceptsByMission(mission.id);
      if (currentAccepts.length >= (mission.requiredVolunteers || 0)) {
        alert("æ­¤ä»»å‹™å·²é¡æ»¿");
        renderVolunteerMissionList();
        return;
      }

      // æª¢æŸ¥æ˜¯å¦å·²ç¶“æ¥å—é
      const alreadyAccepted = currentAccepts.some(accept => accept.volunteerId === currentUser.id);
      if (alreadyAccepted) {
        alert("ä½ å·²ç¶“æ¥å—éæ­¤ä»»å‹™äº†");
        renderVolunteerMissionList();
        return;
      }

      // å‰µå»ºæ¥å—è¨˜éŒ„
      const acceptRecord = {
        id: genId("accept"),
        missionId: mission.id,
        volunteerId: currentUser.id,
        volunteerName: currentUser.name,
        acceptedAt: new Date().toISOString()
      };

      addAccept(acceptRecord);

      // æ›´æ–°ä»»å‹™çš„å·²æ¥å—äººæ•¸
      updateMission(mission.id, {
        acceptedCount: currentAccepts.length + 1
      });

      // ç™¼é€é€šçŸ¥çµ¦ç™¼å¸ƒè€…
      addNotification({
        id: genId("notification"),
        publisherId: mission.postedBy,
        type: "volunteer_accepted",
        message: "æœ‰æ–°å¿—å·¥æ¥æ”¶äº†æ‚¨çš„ä»»å‹™",
        missionId: mission.id,
        missionTitle: mission.title,
        volunteerName: currentUser.name,
        createdAt: new Date().toISOString(),
        read: false
      });

      alert("æˆåŠŸæ¥å—ä»»å‹™ï¼");
      renderVolunteerMissionList();
    }

    function removeVolunteerFromMission(missionId, volunteerId) {
      // ç¢ºèªæ“ä½œ
      if (!confirm("ç¢ºå®šè¦å°‡æ­¤å¿—å·¥å¾ä»»å‹™ä¸­ç§»é™¤å—ï¼Ÿ")) return;

      const db = loadDB();
      const mission = getMissionById(missionId);
      if (!mission) {
        alert("ä»»å‹™ä¸å­˜åœ¨");
        return;
      }

      // æª¢æŸ¥æ¬Šé™ï¼ˆåªæœ‰ä»»å‹™ç™¼å¸ƒè€…æ‰èƒ½ç§»é™¤å¿—å·¥ï¼‰
      if (mission.postedBy !== currentUser.id) {
        alert("æ‚¨æ²’æœ‰æ¬Šé™åŸ·è¡Œæ­¤æ“ä½œ");
        return;
      }

      // æ‰¾åˆ°ä¸¦åˆªé™¤æ¥å—è¨˜éŒ„
      const acceptIndex = db.accepts.findIndex(
        accept => accept.missionId === missionId && accept.volunteerId === volunteerId
      );

      if (acceptIndex === -1) {
        alert("æœªæ‰¾åˆ°è©²å¿—å·¥çš„æ¥å—è¨˜éŒ„");
        return;
      }

      // åˆªé™¤æ¥å—è¨˜éŒ„
      db.accepts.splice(acceptIndex, 1);

      // æ›´æ–°ä»»å‹™çš„å·²æ¥å—äººæ•¸
      const remainingAccepts = db.accepts.filter(accept => accept.missionId === missionId);
      const missionIndex = db.missions.findIndex(m => m.id === missionId);
      if (missionIndex >= 0) {
        db.missions[missionIndex].acceptedCount = remainingAccepts.length;
      }

      // ä¿å­˜æ•¸æ“šåº«
      saveDB(db);

      alert("å·²æˆåŠŸç§»é™¤å¿—å·¥ï¼");
      const updatedMission = getMissionById(missionId);
      renderPublisherMissionDetail(updatedMission);
    }

    function completeMission(missionId) {
      // ç¢ºèªæ“ä½œ
      if (!confirm("ç¢ºå®šè¦å°‡æ­¤ä»»å‹™æ¨™è¨˜ç‚ºå·²å®Œæˆå—ï¼Ÿ")) return;

      const mission = getMissionById(missionId);
      if (!mission) {
        alert("ä»»å‹™ä¸å­˜åœ¨");
        return;
      }

      // æª¢æŸ¥å¿—å·¥æ˜¯å¦æ¥å—äº†æ­¤ä»»å‹™
      const accepts = getAcceptsByMission(missionId);
      const myAccept = accepts.find(accept => accept.volunteerId === currentUser.id);
      if (!myAccept) {
        alert("æ‚¨å°šæœªæ¥å—æ­¤ä»»å‹™");
        return;
      }

      // å°‡ä»»å‹™æ¨™è¨˜ç‚ºå·²å®Œæˆ
      updateMission(missionId, { 
        status: "completed",
        completedAt: new Date().toISOString()
      });

      alert("ä»»å‹™å·²æ¨™è¨˜ç‚ºå·²å®Œæˆï¼");
      renderVolunteerMissionList();
    }
  </script>

  <body>
    <div id="app"></div>
    <script>
      // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
      document.addEventListener('DOMContentLoaded', function() {
        console.log('Page loaded, initializing app...');
        navigateTo('roleSelect');
      });
    </script>
  </body>
</html>
